<html>

    {% include 'AgriTrust/import.html' %}
    {% include 'AgriTrust/css.html' %}

    <body> 
        {% include 'AgriTrust/header.html' %}

        <div>
        
            <h5> Employees </h5>

            <div>
                <div>

                    <div>
                        <button onclick="window.location.href='{% url 'employee_add' %}';"> Add Employee </button> 
                    </div>

                    <div>
                        <input type="text" oninput="handleSearchEmployee()" id="search-employee" placeholder="Search Employee"> 
                    </div>

                    <div>
                        <select id = "type-select" oninput="handleSearchEmployee()"> 
                            <option value="all"> All </option>
                            <option value="admin"> Admin </option>
                            <option value="cashier"> Cashier </option>
                        </select>
                    </div>
                    
                    <div>
                        <table id = "employee-table" class = "table table-bordered table-hover table-responsive"> 
                            <tr> 
                                <th> <input type="checkbox" id="select-all" onclick="handleSelectAllClick()"> </th>
                                <th> ID </th>
                                <th> Fullname </th>
                                <th> Email </th>
                                <th> Username </th>
                                <th> Type </th>
                            </tr>

                            {%for employee in employees%}
                            <tr class = "employee-row">
                                <td> <input type="checkbox" id = "select-row" onclick="handleCheckboxClick()" value = "{{employee.id}}"> </td>
                                <td> {{employee.number_display}} </td>
                                <td> {{employee.fullname}} </td>
                                <td> {{employee.email}} </td>
                                <td> {{employee.username}} </td>
                                <td> {{employee.type}} </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>

                    <div>
                        <p id = "selected-indicator"> </p>
                        <div > 
                            <button onclick="handleDeleteEmployees()"> Delete Selected Employee </button> 
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>


        <script> 
            var selected = 0; 
            var totalRows = 0;
            var selectedIds = [];

            function getTotalRows () {
                document.querySelectorAll(".employee-row").forEach(row => {
                    totalRows++; 
                })
            }

            function setSelectedMarker(){
                document.getElementById("selected-indicator").innerHTML = selected + " of "  + totalRows;
            }

            function handleCheckboxClick(){

                document.querySelectorAll(".employee-row").forEach(row => {
                    var client_id = row.children[0].children[0].value;
                    if (row.children[0].children[0].checked == true) {

                        if(selectedIds.includes(client_id) == false){
                            selectedIds.push(client_id);
                            selected++;
                            console.log("not here");
                            
                        }

                    }
                    else if (row.children[0].children[0].checked == false) {
                        if(selectedIds.includes(client_id) == true){
                            selectedIds.splice(selectedIds.indexOf(client_id), 1);
                            selected--;
                        }
                    }
                })

                console.log(selectedIds);

                setSelectedMarker();
            }
                    
            function handleSelectAllClick(){

                var selectAll = document.getElementById("select-all").checked

                if (selectAll == true) {
                    document.querySelectorAll(".employee-row").forEach(row => {
                        row.children[0].children[0].checked = true
                    })
                }

                else if (selectAll == false) {
                    document.querySelectorAll(".employee-row").forEach(row => {
                        row.children[0].children[0].checked = false
                    })
                }

                handleCheckboxClick();
            }
            
            // function redirectToClientInfo(event, clientId) {
            //     if (event.target.type === "checkbox") {
            //         return;
            //     }

            //     return window.location.href = 'clients/' + clientId;
            // }

            async function handleDeleteEmployees() {
                
                const response = await fetch("{% url 'server_delete_employee' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'employee_ids': selectedIds
                    })
                })

                await response.json();

                return window.location.href = "{% url 'employee_list' %}";

            }
            
            async function handleSearchEmployee() {
                
                const response = await fetch("{% url 'server_get_employee_by_search' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'name': document.getElementById("search-employee").value,
                        'pagination' : 1, 
                        'type' : document.getElementById("type-select").value
                    })
                })    

                const data = await response.json();
                console.log(data);
                const employees = data["employees"];
                
                var table_body = document.getElementById("employee-table");
                table_body.innerHTML = "";
                
                table_body.innerHTML += `
                    <tr>
                        <th> <input type="checkbox" id="select-all" onclick="handleSelectAllClick()"> </th>
                        <th> ID </th>
                        <th> Fullname </th>
                        <th> Email </th>
                        <th> Username </th>
                        <th> Type </th>
                    </tr>
                `

                for (employee of employees) {
                    table_body.innerHTML += `
                    <tr class = "employee-row">
                        <td> <input type="checkbox" id = "select-row" onclick="handleCheckboxClick()"> </td>
                        <td> ${employee.number_display} </td>
                        <td> ${employee.fullname} </td>
                        <td> ${employee.email} </td>
                        <td> ${employee.username} </td>
                        <td> ${employee.type} </td>
                    </tr>
                    `
                }
            }

            getTotalRows();
            setSelectedMarker();
        </script> 
    </body>
<html>